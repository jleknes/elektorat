<!DOCTYPE html>
<html>
<head>
	<!--<script src="http://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.9/require.min.js"></script>-->
	<title>Lek med Leaflet</title>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css"/>
	<link rel="stylesheet" href="strategicmap.css"/>
	<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
	<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
	
</head>
<body>
	<div id="map"></div>
	<script type="text/javascript">

	var map = L.map('map').setView([63.5, 10], 7);
	var fylke = '16';
	var party = 'SV';
	var kommunegrenser;
	var valgresultat;
	var kommuneLayer;



	$.getJSON("valgresultat_2013_kommuner.json").done(function(json) {
		valgresultat=json;
		kommuneLayer.setStyle(style);
		info.addTo(map);

	}).fail(function() {
		console.log("feil under lasting av valgresultat");
	});

	function getElectionData(kommuneId) {
		if (valgresultat == undefined) {
			console.log("called to early");
			return 0.0;
		}
		for (i=0; i<valgresultat.length;i++) {
			if (valgresultat[i].KommuneID===kommuneId && valgresultat[i].Parti===party) return valgresultat[i];
		}
		return 0.0;
	}

	$.getJSON("kommuner.geojson").done(function(json) {
		kommunegrenser = json;

		kommuneLayer = L.geoJson(kommunegrenser, {
			style:style,
			onEachFeature:onEachFeature,
			filter: function(featureData) {
				var featureFylke = featureData.properties.KOMM.toString().substring(0,2);
				return featureFylke === fylke;
			}
		}).addTo(map);
	});

	function style(feature) {
		var oppslutning = getElectionData(feature.properties.KOMM);
		//console.log(feature.properties.KOMM+" "+oppslutning);
		return {
			fillColor: getColor(oppslutning.ProsentAndel),
			weight: 2,
			opacity: 1,
			color: 'white',
			dashArray: '3',
			fillOpacity: 0.7
		};
	}

	function getColor(p) {
		return p > 8.0 ? '#CC0000' :
		p > 6.5  ? '#FF0000' :
		p > 5.0  ? '#FF3333' :
		p > 4.0  ? '#FF6666' :
		p > 2.5   ? '#FF9999' :
		p > 1.0   ? '#FECCCC' :
		p > 0   ? '	#FFE6E6' :
		'#000000';
	}

	function zoomTilKommune(e) {
		map.fitBounds(e.target.getBounds());
	}
	function onEachFeature(feature, layer) {
		layer.on({
			mouseover: highlightFeature,
			mouseout: resetHighlight,
			click: zoomTilKommune
		});
	}
	function highlightFeature(e) {
		info.update(layer.feature.properties);
	}

	function resetHighlight(e) {
		info.update();
	}

	var info = L.control();

	info.onAdd = function (map) {
    	this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
	    this.update();
	    return this._div;
	};

	// method that we will use to update the control based on feature properties passed
	info.update = function (props) {
		var electionData = getElectionData(props.KOMM);
		this._div.innerHTML = 'Oppslutning' +  (electionData ?
		'<b>' + electionData.ProsentAndel + '</b><br /> Navn:' + props.NAVN + ' people / mi<sup>2</sup>'
		: 'Hover over a state');
	};

	var legend = L.control({position: 'bottomright'});

	legend.onAdd = function (map) {

	var div = L.DomUtil.create('div', 'info legend'),
	grades = [0, 1.0, 2.5, 4.0, 5.0, 6.5, 8.0],
	labels = [];

    // loop through our density intervals and generate a label with a colored square for each interval
    for (var i = 0; i < grades.length; i++) {
    	div.innerHTML +=
    	'<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
    	grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
    }

    return div;
};		
legend.addTo(map);


</script>
</body>
</html>