<!DOCTYPE html>
<html>
<head>
	<!--<script src="http://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.9/require.min.js"></script>-->
	<title>Lek med Leaflet</title>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css"/>
	<link rel="stylesheet" href="strategicmap.css"/>
	<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
	<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
	
</head>
<body>
	<div id="map"></div>
	<script type="text/javascript">

	var map = L.map('map').setView([63.5, 10], 7);
	var fylke = '16';
	var party = 'SV';
	var kommunegrenser;
	var valgresultat = {};
	var kommuneLayer;

	loadElectionData();
	loadMap();

	function changeInPercent(change, totalVotes) {
		return (100*change/totalVotes).toFixed(2);
	}

	function loadElectionData() {
		$.getJSON("valgresultat_2013_kommuner.json", function(data) {
			$.each(data, function(index, value) {
				if (value.Parti === party) {
					valgresultat[value.KommuneID] = value;
					valgresultat[value.KommuneID].ProsentEndring09=changeInPercent(value.EndringStemmer09, value.StemmerTotalt);
					valgresultat[value.KommuneID].ProsentEndring11=changeInPercent(value.EndringStemmer11, value.StemmerTotalt);
				}
			});
		}).done(function(json) {		
			kommuneLayer.setStyle(style);
			info.addTo(map);
		}).fail(function() {
			console.log("feil under lasting av valgresultat");			
		});
	}

	function getElectionData(kommuneId) {
		if (valgresultat == undefined || valgresultat[kommuneId] == undefined) {
			return 0.0;
		}
		return valgresultat[kommuneId];
	}
	function loadMap() {
		$.getJSON("kommuner.geojson").done(function(json) {
			kommunegrenser = json;
			kommuneLayer = L.geoJson(kommunegrenser, {
				style:style,
				onEachFeature:onEachFeature,
				filter: function(featureData) {
					var featureFylke = featureData.properties.KOMM.toString().substring(0,2);
					return featureFylke === fylke;
				}
			}).addTo(map);
		});
	}

	function style(feature) {
		var oppslutning = getElectionData(feature.properties.KOMM);
		return {
			fillColor: getColor(oppslutning.ProsentAndel),
			weight: 2,
			opacity: 1,
			color: 'white',
			dashArray: '3',
			fillOpacity: 0.7
		};
	}


	function zoomTilKommune(e) {
		map.fitBounds(e.target.getBounds());
	}
	function onEachFeature(feature, layer) {
		layer.on({
			mouseover: highlightFeature,
			mouseout: resetHighlight,
			click: zoomTilKommune
		});
	}
	function highlightFeature(e) {
	    var layer = e.target;

    	layer.setStyle({
	        weight: 5,
    	    color: '#666',
        	dashArray: '',
        	fillOpacity: 0.7
    	});

	    if (!L.Browser.ie && !L.Browser.opera) {
	        layer.bringToFront();
	    }
		info.update(layer.feature.properties);
	}

	function resetHighlight(e) {		
	    var layer = e.target;

    	layer.setStyle({
	        weight: 2,
    	    color: 'white',
        	dashArray: '3',
        	fillOpacity: 0.7
    	});
		info.update();
	}

	var info = L.control();

	info.onAdd = function (map) {
    	this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
    	this.update();
    	return this._div;
    };


	// method that we will use to update the control based on feature properties passed
	info.update = function (props) {
		if (props == undefined) {
			this._div.innerHTML = "";
			return; 
		}
		var electionData = getElectionData(props.KOMM);
		var kommuneInfo ='Oppslutning: ' + electionData.ProsentAndel + ' %<br /> Navn: ' + props.NAVN+'<br />Antall SV-stemmer: '+electionData.StemmerTotalt;
		kommuneInfo+='<br/>Prosentvis endring (11): '+electionData.ProsentEndring11 +' %<br/>Prosentvis endring (09): '+electionData.ProsentEndring09+' %';
		this._div.innerHTML = kommuneInfo;
	};

	function getColor(p) {
		return p > 6.5  ? '#FF0000' :
		p > 5.0  ? '#FF3333' :
		p > 3.5   ? '#FF7777' :
		p > 2.0   ? '#FF9999' :
		p > 0   ? '	#FFCCCC' :
		'#000000';
	}

	var legend = L.control({position: 'bottomright'});

	legend.onAdd = function (map) {

		var div = L.DomUtil.create('div', 'info legend'),
		grades = [0, 2.0, 3.5, 5.0, 6.5],
		labels = [];

	    // loop through our density intervals and generate a label with a colored square for each interval
    	for (var i = 0; i < grades.length; i++) {
	    	div.innerHTML +=
    		'<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
	    	grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
	    }

    	return div;
	};		
	legend.addTo(map);


</script>
</body>
</html>